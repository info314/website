<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Daniel Schwalbe">
        <link rel="canonical" href="https://info314.giantfirewall.com/assignments/pihole-project-3/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Part 3 - Installing the recursive DNS Server - INFO 314 Course Resources</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/color-brewer.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">INFO 314 Course Resources</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Projects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">1 - Pi Setup</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../pi-setup/" class="dropdown-item">Raspberry Pi Setup</a>
</li>
            
<li>
    <a href="../networkd-setup/" class="dropdown-item">networkd Setup</a>
</li>
            
<li>
    <a href="../../resources/wifi-reference/" class="dropdown-item">Wifi Reference</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2 - Set up a DHCP Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../dhcp-setup/" class="dropdown-item">Installing and Configuring the ISC DHCP Server</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">3 - Configure Routing and NAT</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../router-setup/" class="dropdown-item">Router Setup</a>
</li>
            
<li>
    <a href="../../resources/iptables/" class="dropdown-item">Introduction to iptables</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">4 - Configure a DNS Resolver</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../resolver-setup/" class="dropdown-item">DNS Resolver Setup</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">5 - Extra Credit - Build a Pi-Hole (Optional)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../pihole-project-1/" class="dropdown-item">Part 1 - Installing the Raspberry Pi OS</a>
</li>
            
<li>
    <a href="../pihole-project-2/" class="dropdown-item">Part 2 - Installing the Pi-Hole Application</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Part 3 - Installing the recursive DNS Server</a>
</li>
            
<li>
    <a href="../pihole-project-4/" class="dropdown-item">Part 4 - Make Pi-Hole work for you!</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../lab1/" class="dropdown-item">Lab 1 - Core Technical Skills</a>
</li>
                                    
<li>
    <a href="../lab2/" class="dropdown-item">Lab 2 - Analyze DNS & HTTP in Wireshark</a>
</li>
                                    
<li>
    <a href="../lab3/" class="dropdown-item">Lab 3 - Analyzing DHCP and ARP with Wireshark</a>
</li>
                                    
<li>
    <a href="../lab4/" class="dropdown-item">Lab 4 - Analyze Zeroconf in Wireshark</a>
</li>
                                    
<li>
    <a href="../lab5/" class="dropdown-item">Lab 5 - Analyze TCP with ncat and Wireshark</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Concepts and Theory</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../notes/dns-overview/" class="dropdown-item">Domain Name System (DNS)</a>
</li>
            
<li>
    <a href="../../notes/router-overview/" class="dropdown-item">Routers</a>
</li>
            
<li>
    <a href="../../notes/ethernet-switches/" class="dropdown-item">Ethernet Switches</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Guides</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/pi-materials/" class="dropdown-item">Getting Pi Materials</a>
</li>
            
<li>
    <a href="../../resources/digital-ocean/" class="dropdown-item">Digital Ocean Signup</a>
</li>
            
<li>
    <a href="../../resources/address-planning/" class="dropdown-item">Basic IP Address Planning</a>
</li>
            
<li>
    <a href="../../resources/iptables/" class="dropdown-item">Introduction to Iptables</a>
</li>
            
<li>
    <a href="../../resources/netfilter-hooks/" class="dropdown-item">Understanding Netfilter/Iptables Hooks</a>
</li>
            
<li>
    <a href="../../resources/wifi-reference/" class="dropdown-item">Linux Wireless Configuration</a>
</li>
            
<li>
    <a href="../../resources/zone-file-format/" class="dropdown-item">Zone File Reference</a>
</li>
            
<li>
    <a href="../../resources/vlans-and-dummies/" class="dropdown-item">Special Network Interfaces (VLANs and Dummies)</a>
</li>
            
<li>
    <a href="../../resources/configure-routing-links/" class="dropdown-item">Configuring Routing Links</a>
</li>
            
<li>
    <a href="../../resources/setup-wireguard/" class="dropdown-item">Install and Configure WireGuard</a>
</li>
            
<li>
    <a href="../../resources/setup-frr/" class="dropdown-item">Install Free Range Routing (FRR)</a>
</li>
            
<li>
    <a href="../../resources/ssh-agent/" class="dropdown-item">Using ssh-agent</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Configure an Authoritative Name Server</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../dns-zone-setup/" class="dropdown-item">Authoritative Zone Setup</a>
</li>
            
<li>
    <a href="../../resources/zone-file-format/" class="dropdown-item">DNS Zone Reference</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Quick Reference</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../resources/markdown/" class="dropdown-item">Intro to Markdown</a>
</li>
            
<li>
    <a href="../../resources/bash/" class="dropdown-item">Intro to Bash</a>
</li>
            
<li>
    <a href="../../resources/host-config/" class="dropdown-item">Mac/Win/Linux Networking</a>
</li>
            
<li>
    <a href="../../resources/wireshark-install/" class="dropdown-item">Install Wireshark</a>
</li>
            
<li>
    <a href="../../resources/tshark-install/" class="dropdown-item">Install TShark</a>
</li>
            
<li>
    <a href="../../resources/manage-dhcp/" class="dropdown-item">Troubleshooting DHCP</a>
</li>
            
<li>
    <a href="../../resources/dns-clients/" class="dropdown-item">Managing DNS Clients</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../contact/" class="nav-link">Contact Us</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../pihole-project-2/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../pihole-project-4/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/info314/website" class="nav-link">info314/website</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#pi-hole-personal-rdns-server-appliance-setup-guide" class="nav-link">Pi-Hole &amp; Personal rDNS Server Appliance Setup Guide</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#part-3-installing-the-recursive-dns-server" class="nav-link">Part 3: Installing the recursive DNS Server</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#your-very-own-recursive-dns-server" class="nav-link">Your very own recursive DNS server</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#installing-unbound" class="nav-link">Installing Unbound</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="pi-hole-personal-rdns-server-appliance-setup-guide">Pi-Hole &amp; Personal rDNS Server Appliance Setup Guide<a class="headerlink" href="#pi-hole-personal-rdns-server-appliance-setup-guide" title="Permanent link">&para;</a></h1>
<p><br></p>
<h2 id="part-3-installing-the-recursive-dns-server">Part 3: Installing the recursive DNS Server<a class="headerlink" href="#part-3-installing-the-recursive-dns-server" title="Permanent link">&para;</a></h2>
<p><br></p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>This guide will walk you through the steps necessary to install and configure a Pi-Hole on your Raspberry Pi, along with a personal recursive DNS server that will keep your DNS queries out of your ISP's immediate view. </p>
<p>The core sections of this guide are broken down into 4 parts:</p>
<ol>
<li><a href="/assignments/pihole-project-1">Installing the Raspberry Pi OS</a></li>
<li><a href="/assignments/pihole-project-2">Installing the Pi-Hole Application</a></li>
<li><strong>Installing the recursive DNS Server</strong> (you are here)</li>
<li><a href="/assignments/pihole-project-4">Make Pi-Hole work for you!</a></li>
</ol>
<p><br></p>
<h2 id="your-very-own-recursive-dns-server">Your very own recursive DNS server<a class="headerlink" href="#your-very-own-recursive-dns-server" title="Permanent link">&para;</a></h2>
<p>During Checkpoint 4 of the Pi projects, we set up ISC BIND as a recursive DNS server. We will be doing something very similar for the Pi-Hole project, except we will use NLnet Labs' <a href="https://en.wikipedia.org/wiki/Unbound_(DNS_server)">Unbound</a>, another popular DNS server software. The reason for selecting Unbound (a word play on BIND) is that it is the recommended companion to Pi-Hole, and the two play well together. </p>
<p><br></p>
<h2 id="installing-unbound">Installing Unbound<a class="headerlink" href="#installing-unbound" title="Permanent link">&para;</a></h2>
<p>Connect to your Pi using SSH. You should now be able to use <code>ssh pi@&lt;ip_address&gt;</code>instead of having to use <code>pihole.local</code> Since your Pi should be connected to your WiFi router over Ethernet, you can do this using the WiFi connection of your laptop, and you don't have to be in close proximity of your Pi. Ance logged in, run these commands:</p>
<pre class="highlight"><code class="language-bash">sudo apt update
sudo apt install unbound</code></pre>
<p><br></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You will likely see a scary-looking error message during the installation process, warning you that something failed to start. You can safely ignore that at this stage of the installation.</p>
</div>
<p>Next, let's configure Unbound! The configuration example that follows has been customized for use with a Pi-Hole:  </p>
<pre class="highlight"><code class="language-bash">server:
    # If no logfile is specified, syslog is used
    # logfile: "/var/log/unbound/unbound.log"
    verbosity: 0

    interface: 127.0.0.1
    port: 5335
    do-ip4: yes
    do-udp: yes
    do-tcp: yes

    # May be set to yes if you have IPv6 connectivity
    do-ip6: no

    # You want to leave this to no unless you have *native* IPv6. With 6to4 and
    # Terredo tunnels your web browser should favor IPv4 for the same reasons
    prefer-ip6: no

    # Use this only when you downloaded the list of primary root servers!
    # If you use the default dns-root-data package, unbound will find it automatically
    #root-hints: "/var/lib/unbound/root.hints"

    # Trust glue only if it is within the server's authority
    harden-glue: yes

    # Require DNSSEC data for trust-anchored zones, if such data is absent, 
    # the zone becomes BOGUS
    harden-dnssec-stripped: yes

    # Don't use Capitalization randomization as it known to cause DNSSEC issues sometimes
    # see https://discourse.pi-hole.net/t/unbound-stubby-or-dnscrypt-proxy/9378 
    # for further details
    use-caps-for-id: no

    # Reduce EDNS reassembly buffer size.
    # Suggested by the unbound man page to reduce fragmentation reassembly problems
    edns-buffer-size: 1472

    # Perform prefetching of close to expired message cache entries
    # This only applies to domains that have been frequently queried
    prefetch: yes

    # One thread should be sufficient, can be increased on beefy machines. In reality 
    # for most users running on small networks or on a single machine, it should be
    # unnecessary to seek performance enhancement by increasing num-threads above 1.
    num-threads: 1

    # Ensure kernel buffer is large enough to not lose messages in traffic spikes
    so-rcvbuf: 1m

    # Ensure privacy of local IP ranges
    private-address: 192.168.0.0/16
    private-address: 169.254.0.0/16
    private-address: 172.16.0.0/12
    private-address: 10.0.0.0/8
    private-address: fd00::/8
    private-address: fe80::/10</code></pre>
<p>Copy the contents and paste them into the file opened by this command:</p>
<pre class="highlight"><code class="language-bash">sudo nano /etc/unbound/unbound.conf.d/pi-hole.conf</code></pre>
<p>Save the file and exit the editor. Next we restart Unbound and test to make sure it's working:</p>
<pre class="highlight"><code>sudo service unbound restart
dig pi-hole.net @127.0.0.1 -p 5335</code></pre>
<p>That second command should be familiar from Checkpoint 4. Note the <code>-p 5335</code> at the end. This means query the DNS server listening on localhost (127.0.0.1), but do so on port 5335 instead of the standard DNS port 53.</p>
<p>The reason we configured Unbound to listen on a different port than standard DNS port 53 is that the Pi-Hole DNS server is already using port 53, and you cannot have two services listen on the same port. But since Unbound will only be used internally by the Pi-Hole DNS Server as its "Upstream" DNS provider (instead of Google or your ISP's DNS Server), the non-standard port will not be exposed to clients and therefore won't create issues.</p>
<p>While we are still logged into the Pi via SSH, now would be a good time to change the randomly generated Web Admin password. This can only be done via SSH, using the <code>pihole</code> command:</p>
<pre class="highlight"><code>sudo pihole -a -p</code></pre>
<p>You will be prompted to type a new password, and after pressing Enter, type it again for confirmation.</p>
<p>Next, we will finish configuring the Pi-Hole via the Web Admin interface. Open a browser and type the static IP address of the Pi-Hole into the address bar, followed by /admin - for example <a href="http://10.10.10.10/admin">http://10.10.10.10/admin</a></p>
<p>The Pi-Hole Dashboard page should appear in your browser.</p>
<p>Click on "Login" in the left sidebar menu.</p>
<p>Enter either the new password you set earlier via SSH, or if you did not change it, use the randomly generated password you captured during the setup process.</p>
<p>Click "Log in"</p>
<p>You should now see a more detailed version of the dashboard. In the now expanded left sidebar menu, click on "Settings." </p>
<p>On the page that loads, select "DNS" from the top menu.</p>
<p>Uncheck any checkboxes from the left "Upstream DNS Servers" column. Most likely, only Google (ECS) is selected.</p>
<p>In the right "Upstream DNS Servers" column, click the square under "Custom 1 (IPv4)" to place a checkmark into it. In the text field below the checkmark, type <code>127.0.0.1#5335</code> - be sure to include the hashmark / pound sign, and no spaces.</p>
<p><strong>Make sure you scroll down and click the "Save" button on the very bottom right of the page!</strong></p>
<p>This instructs Pi-Hole to forward any upstream DNS queries to Unbound listening on localhost (127.0.0.1), using port 5335. Unbound will then retrieve the information from the Root, TLD, and Authoritative name servers, and will cache the information until the TTL expires. This will speed up subsequent queries for the same domain.</p>
<p><em>Did you remember to click Save?</em></p>
<p>Your Pi-Hole is now ready for use. Be sure to check out all of the other settings and configuration options! </p>
<p><br></p>
<h3 id="next-up-make-pi-hole-work-for-you">Next Up: <a href="/assignments/pihole-project-4">Make Pi-Hole work for you!</a><a class="headerlink" href="#next-up-make-pi-hole-work-for-you" title="Permanent link">&para;</a></h3></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 Daniel Schwalbe</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
